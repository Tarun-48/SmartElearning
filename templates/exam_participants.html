<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Participants - Smart E-Learning</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <style>
        main {
            padding: 40px 20px;
            text-align: center;
        }

        .search-sort-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .search-sort-container input,
        .search-sort-container select {
            padding: 10px 15px;
            border-radius: 25px;
            border: 1px solid #ccc;
            font-size: 1em;
            outline: none;
        }

        table {
            width: 80%;
            margin: 0 auto;
            border-collapse: collapse;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        table th, table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        table th {
            background-color: #1abc9c;
            color: white;
        }

        table tr:hover {
            background-color: #f1f1f1;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #1abc9c;
            color: white;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.2s;
            margin-top: 20px;
        }

        .btn:hover {
            background-color: #16a085;
            transform: scale(1.05);
        }

        .btn-danger {
            background-color: #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .stats {
            margin: 20px 0;
            font-size: 1.1em;
            color: #555;
        }
    </style>
</head>

<body>
    <header>
        <h1>Exam Participants</h1>
        <nav>
            <a href="{{ url_for('home') }}">Home</a>
            <a href="{{ url_for('exam_list') }}">All Exams</a>
            <a href="{{ url_for('logout') }}" class="logout">Logout</a>
        </nav>
    </header>

    <main>
        <h2>Participants of <span style="color:#1abc9c;">{{ exam.title }}</span></h2>

        <div class="stats">
            <strong>Total Participants:</strong> {{ total_participants }} |
            <strong>Average Score:</strong> {{ avg_score }}
        </div>

        <!-- üîç Search & Sort Controls -->
        <div class="search-sort-container">
            <input type="text" id="searchInput" placeholder="Search by student name...">
            <select id="sortSelect">
                <option value="name">Sort by Name (A‚ÄìZ)</option>
                <option value="score">Sort by Score (High ‚Üí Low)</option>
            </select>
            <button class="btn" id="downloadBtn">‚¨áÔ∏è Download CSV</button>
            {% if g.user.is_admin %}
            <form action="{{ url_for('delete_participants', exam_id=exam.id) }}" method="POST" style="display:inline;">
                <button type="submit" id="deleteBtn" class="btn btn-danger" style="display:none;"
                    onclick="return confirm('Are you sure you want to delete all participants for this exam? This action cannot be undone.');">
                    üóëÔ∏è Delete All Participants
                </button>
            </form>
            {% endif %}
        </div>

        {% if results %}
            <table id="participantsTable">
                <thead>
                    <tr>
                        <th>Student Name</th>
                        <th>Email</th>
                        <th>Score</th>
                        <th>Date Taken</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r, user in results %}
                        <tr>
                            <td>{{ user.fullname }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ r.score }}</td>
                            <td>{{ r.date_taken.strftime('%Y-%m-%d %H:%M:%S') if r.date_taken else 'N/A' }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No students have taken this exam yet.</p>
        {% endif %}

        <a href="{{ url_for('exam_list') }}" class="btn">‚Üê Back to Exam List</a>
    </main>

    <footer>
        <p>¬© 2025 Smart E-Learning System</p>
    </footer>

    <script>
        // üîç Search Function
        const searchInput = document.getElementById('searchInput');
        const table = document.getElementById('participantsTable');
        const rows = table ? table.querySelectorAll('tbody tr') : [];

        searchInput?.addEventListener('keyup', function () {
            const filter = searchInput.value.toLowerCase();
            rows.forEach(row => {
                const name = row.cells[0].textContent.toLowerCase();
                row.style.display = name.includes(filter) ? '' : 'none';
            });
        });

        // ‚¨ÜÔ∏è Sort Function
        const sortSelect = document.getElementById('sortSelect');
        sortSelect?.addEventListener('change', function () {
            const sortBy = sortSelect.value;
            const sortedRows = Array.from(rows);

            sortedRows.sort((a, b) => {
                if (sortBy === 'name') {
                    return a.cells[0].textContent.localeCompare(b.cells[0].textContent);
                } else if (sortBy === 'score') {
                    return parseFloat(b.cells[2].textContent) - parseFloat(a.cells[2].textContent);
                }
            });

            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            sortedRows.forEach(row => tbody.appendChild(row));
        });

        // üì• CSV Download Function
        document.getElementById('downloadBtn')?.addEventListener('click', function () {
            let csv = "Student Name,Email,Score,Date Taken\n";
            rows.forEach(row => {
                const cols = Array.from(row.cells).map(td => `"${td.textContent}"`);
                csv += cols.join(",") + "\n";
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `participants_{{ exam.title|replace(' ', '_') }}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            // ‚úÖ Show Delete Button after Download
            const deleteBtn = document.getElementById('deleteBtn');
            if (deleteBtn) deleteBtn.style.display = 'inline-block';
        });
    </script>
</body>
</html>
